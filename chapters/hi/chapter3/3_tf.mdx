<FrameworkSwitchCourse {fw} />

# рдореЙрдбрд▓ рдХрд┐ рдлрд╛рдЗрди-рдЯреНрдпреВрдирд┐рдВрдЧ Keras рдХреЗ рд╕рд╛рде

<CourseFloatingBanner chapter={3}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/notebooks/blob/master/course/hi/chapter3/section3_tf.ipynb"},
    {label: "Aws Studio", value: "https://studiolab.sagemaker.aws/import/github/huggingface/notebooks/blob/master/course/hi/chapter3/section3_tf.ipynb"},
]} />

рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдк рдЕрдВрддрд┐рдо рдЦрдВрдб рдореЗрдВ рд╕рднреА рдбреЗрдЯрд╛ рдкреВрд░реНрд╡ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХрд╛рд░реНрдп рдХрд░ рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдореЙрдбрд▓ рдХреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╕ рдХреБрдЫ рд╣реА рдЪрд░рдг рд╢реЗрд╖ рд╣реИрдВред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ `model.fit()` рдХрдорд╛рдВрдб CPU рдкрд░ рдмрд╣реБрдд рдзреАрдореА рдЧрддрд┐ рд╕реЗ рдЪрд▓реЗрдЧрд╛ред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ GPU рд╕реЗрдЯ рдЕрдк рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк [Google Colab](https://colab.research.google.com/) рдкрд░ рдирд┐рдГрд╢реБрд▓реНрдХ GPU рдпрд╛ TPU рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдХреЛрдб рдЙрджрд╛рд╣рд░рдг рдорд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдиреЗ рдкрд┐рдЫрд▓реЗ рдЦрдВрдб рдореЗрдВ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рдкрд╣рд▓реЗ рд╣реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рджрд┐рдпрд╛ рд╣реИред рдпрд╣рд╛рдВ рдПрдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╕рд╛рд░рд╛рдВрд╢ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд┐рд╕рдХреА рдЖрдкрдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

```py
from datasets import load_dataset
from transformers import AutoTokenizer, DataCollatorWithPadding
import numpy as np

raw_datasets = load_dataset("glue", "mrpc")
checkpoint = "bert-base-uncased"
tokenizer = AutoTokenizer.from_pretrained(checkpoint)


def tokenize_function(example):
    return tokenizer(example["sentence1"], example["sentence2"], truncation=True)


tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)

data_collator = DataCollatorWithPadding(tokenizer=tokenizer, return_tensors="tf")

tf_train_dataset = tokenized_datasets["train"].to_tf_dataset(
    columns=["attention_mask", "input_ids", "token_type_ids"],
    label_cols=["labels"],
    shuffle=True,
    collate_fn=data_collator,
    batch_size=8,
)

tf_validation_dataset = tokenized_datasets["validation"].to_tf_dataset(
    columns=["attention_mask", "input_ids", "token_type_ids"],
    label_cols=["labels"],
    shuffle=False,
    collate_fn=data_collator,
    batch_size=8,
)
```

### рдкреНрд░рд╢рд┐рдХреНрд╖рдг

ЁЯдЧ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдорд░ рд╕реЗ рдЖрдпрд╛рдд рдХрд┐рдП рдЧрдП TensorFlow рдореЙрдбрд▓ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА Keras рдореЙрдбрд▓ рд╣реИрдВред рдпрд╣рд╛рдБ Keras рдХрд╛ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдкрд░рд┐рдЪрдп рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

<Youtube id="rnTGBy2ax1c"/>

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рдмрд╛рд░ рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдорд╛рд░рд╛ рдбреЗрдЯрд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕ рдкрд░ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХрдо рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

<Youtube id="AUozVp78dhk"/>

[рдкрд┐рдЫрд▓реЗ рдЕрдзреНрдпрд╛рдп](/course/chapter2) рдХреА рддрд░рд╣, рд╣рдо `TFAutoModelForSequenceClassification` рдХреНрд▓рд╛рд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рджреЛ рд▓реЗрдмрд▓ рдХреЗ рд╕рд╛рде рдХрд░реЗрдВрдЧреЗ: 

```py
from transformers import TFAutoModelForSequenceClassification

model = TFAutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)
```

рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ [рдЕрдзреНрдпрд╛рдп 2](/course/chapter2) рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЖрдкрдХреЛ рдЗрд╕ рдкреВрд░реНрд╡-рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдореЙрдбрд▓ рдХреЛ рдЗрдиреНрд╕реНрдЯреИрдиреНрд╢реАрдРрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдПрдХ рдЪреЗрддрд╛рд╡рдиреА рдорд┐рд▓рддреА рд╣реИред рдРрд╕рд╛ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ BERT рдХреЛ рд╡рд╛рдХреНрдпреЛрдВ рдХреЗ рдЬреЛрдбрд╝реЗ рдХрд╛ рд╡рд░реНрдЧреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдкреВрд░реНрд╡-рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдореЙрдбрд▓ рдХреЗ рдкреНрд░рдореБрдЦ рдХреЛ рддреНрдпрд╛рдЧ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдпреЗ рдЕрдиреБрдХреНрд░рдо рд╡рд░реНрдЧреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдПрдХ рдирдпрд╛ рдкреНрд░рдореБрдЦ рдбрд╛рд▓рд╛ рдЧрдпрд╛ рд╣реИред рдЗрди рдЪреЗрддрд╛рд╡рдирд┐рдпреЛрдВ рд╕реЗ рд╕рдВрдХреЗрдд рдорд┐рд▓рддрд╛ рд╣реИ рдХрд┐ рдХреБрдЫ рд╡рдЬрд╝рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рддреНрдпрд╛рдЧреЗ рдЧрдП рдкреВрд░реНрд╡-рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рдкреНрд░рдореБрдЦ рдХреЗ рдЕрдиреБрд░реВрдк) рдФрд░ рдХреБрдЫ рдЕрдиреНрдп рдХреНрд░рдорд░рд╣рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдП рдЧрдП рдереЗ (рдирдП рдкреНрд░рдореБрдЦ рдХреЗ рд▓рд┐рдП рд╡рд╛рд▓реЗ)ред рдпрд╣ рд╕рдорд╛рдкрди рдЖрдкрдХреЛ рдореЙрдбрд▓ рдХреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЛрддреНрд╕рд╛рд╣рд┐рдд рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде рд╣реЛрдЧрд╛, рдЬреЛ рдХрд┐ рдЕрдм рд╣рдо рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

рдЕрдкрдиреЗ рдбреЗрдЯрд╛рд╕реЗрдЯ рдкрд░ рдореЙрдбрд▓ рдХреЛ рдлрд╛рдЗрди-рдЯреНрдпреВрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдмрд╕ рдЕрдкрдиреЗ рдореЙрдбрд▓ рдХреЛ `compile()` рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдлрд┐рд░ рдЕрдкрдиреЗ рдбреЗрдЯрд╛ рдХреЛ `fit()` рд╡рд┐рдзрд┐ рдореЗрдВ рдкрд╛рд╕ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдпрд╣ рдлрд╝рд╛рдЗрди-рдЯреНрдпреВрдирд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ (рдЬреЛ GPU рдкрд░ рдХреБрдЫ рдорд┐рдирдЯ рд▓реЗрдЧрд╛) рдФрд░ рдЖрдЧреЗ рдЬрд╛ рдХрд░ рдпрд╣ рд╣рд░ рдпреБрдЧ рдпрд╛рдирд┐ рдПрдкреЙрдЪ рдХреЗ рдЕрдВрдд рдореЗрдВ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд╣рд╛рдирд┐ рдпрд╛рдирд┐ рд▓реЙрд╕ рд╕рд╛рде рд╣реА рд╕рддреНрдпрд╛рдкрди рд╣рд╛рдирд┐ рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдЧрд╛ред

<Tip>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ ЁЯдЧ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдорд░ рдореЙрдбрд▓ рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИ рдЬреЛ рдХрд┐ рдЕрдзрд┐рдХрд╛рдВрд╢ Keras рдореЙрдбрд▓ рдирд╣реАрдВ рд╣реЛрддреА - рд╡реЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рдЙрдЪрд┐рдд рд╣рд╛рдирд┐ рдпрд╛рдирд┐ рд▓реЙрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рд╡реЗ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рдЧрдгрдирд╛ рдХрд░рддреЗ рд╣реИрдВред рд╡реЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЗрд╕ рд▓реЙрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ рдЕрдЧрд░ рдЖрдк `compile()` рдореЗрдВ рд▓реЙрд╕ рдЖрд░реНрдЧреВрдореЗрдиреНрдЯ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рддреЛред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдВрддрд░рд┐рдХ рд▓реЙрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд▓реЗрдмрд▓ рдХреЛ рдЗрдирдкреБрдЯ рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рди рдХрд┐ рдПрдХ рдЕрд▓рдЧ рд▓реЗрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ, рдЬреЛ рдХрд┐ Keras рдореЙрдбрд▓ рдХреЗ рд╕рд╛рде рд▓реЗрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ рд╣реИред рдЖрдк рдкрд╛рдареНрдпрдХреНрд░рдо рдХреЗ рднрд╛рдЧ 2 рдореЗрдВ рдЗрд╕рдХреЗ рдЙрджрд╛рд╣рд░рдг рджреЗрдЦреЗрдВрдЧреЗ, рдЬрд╣рд╛рдВ рд╕рд╣реА рд▓реЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдирд╛ рдкреЗрдЪреАрджрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЕрдиреБрдХреНрд░рдо рд╡рд░реНрдЧреАрдХрд░рдг рдХреЗ рд▓рд┐рдП, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдорд╛рдирдХ Keras рд▓реЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдареАрдХ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдпрд╣рд╛рдВ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред

</Tip>

```py
from tensorflow.keras.losses import SparseCategoricalCrossentropy

model.compile(
    optimizer="adam",
    loss=SparseCategoricalCrossentropy(from_logits=True),
    metrics=["accuracy"],
)
model.fit(
    tf_train_dataset,
    validation_data=tf_validation_dataset,
)
```

<Tip warning={true}>

рдпрд╣рд╛рдВ рдПрдХ рдмрд╣реБрдд рд╣реА рд╕рд╛рдорд╛рдиреНрдп рдиреБрдХрд╕рд╛рди рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ - рдЖрдк рдХреЗрд╡рд▓ рд▓реЙрд╕ рдХрд╛ рдирд╛рдо рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд░реВрдк рдореЗ Keras рдХреЛ рдкрд╛рд╕ *рдХрд░ рд╕рдХрддреЗ* рд╣реИ, рд▓реЗрдХрд┐рди рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ Keras рдпрд╣ рдорд╛рдиреЗрдЧрд╛ рдХрд┐ рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдЕрдкрдиреЗ рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рд╕реЙрдлреНрдЯрдореИрдХреНрд╕ рд▓рд╛рдЧреВ рдХрд░ рджрд┐рдпрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдХрдИ рдореЙрдбрд▓ рд╕реЙрдлреНрдЯрдореИрдХреНрд╕ рд▓рд╛рдЧреВ рд╣реЛрдиреЗ рд╕реЗ рдареАрдХ рдкрд╣рд▓реЗ рдорд╛рдиреЛрдВ рдпрд╛рдирд┐ рд╡реИрд▓реНрдпреВрдЬрд╝ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ *logits* рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рдореЗрдВ рд▓реЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдпрд╣ рдмрддрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╣рдорд╛рд░рд╛ рдореЙрдбрд▓ рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рд╕реАрдзреЗ рдХреЙрд▓ рдХрд░рдирд╛, рдмрдЬрд╛рдп рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рдирд╛рдо рд╕реЗред

</Tip>


### рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдирд╛

<Youtube id="cpzq6ESSM5c"/>

рдпрджрд┐ рдЖрдк рдЙрдкрд░ рджрд┐рдП рдЧрдП рдХреЛрдб рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдЪрд▓рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЖрдк рдкрд╛рдПрдВрдЧреЗ рдХрд┐ рд▓реЙрд╕ рдХреЗрд╡рд▓ рдзреАрд░реЗ-рдзреАрд░реЗ рдпрд╛ рдЫрд┐рдЯрдкреБрдЯ рд░реВрдк рд╕реЗ рдШрдЯрддрд╛
рд╣реИред рдЗрд╕рдХрд╛ рдореБрдЦреНрдп рдХрд╛рд░рдг рд╣реИ рд╕реАрдЦрдиреЗ рдХреА рджрд░ рдпрд╛рдирд┐ *рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ*ред рд▓реЙрд╕ рдХреЗ рд╕рд╛рде, рдЬрдм рд╣рдо Keras рдХреЛ рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рдХрд╛ рдирд╛рдо рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИ, рддреЛ
Keras рдЙрд╕ рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рдХреЛ рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рд╕рд╣рд┐рдд рд╕рднреА рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡реИрд▓реНрдпреВрдЬрд╝ рдХреЗ рд╕рд╛рде рдЖрд░рдВрдн рдпрд╛рдирд┐ рдЗрдирд┐рд╢рд▓рд╛рдЗрдЬрд╝ рдХрд░рддрд╛ рд╣реИред рд▓рдВрдмреЗ рдЕрдиреБрднрд╡ рд╕реЗ,
рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдорд░ рдореЙрдбрд▓ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдПрдбрдо рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдмрд╣реБрдд рдХрдо рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рд╕реЗ рд▓рд╛рдн рд╣реЛрддрд╛ рд╣реИрдВ, рдЬреЛ рдХрд┐ 1e-3 рд╣реИ, рдЬрд┐рд╕реЗ 10 рдХреА рдкреЙрд╡рд░ -3 рдпрд╛
0.001  рдХреЗ рд░реВрдк рдореЗрдВ рднреА рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред 5e-5 (0.00005), рдЬреЛ рдХреБрдЫ рдмреАрд╕ рдЧреБрдирд╛ рдХрдо рд╣реИ, рдПрдХ рдмреЗрд╣рддрд░ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдмрд┐рдВрджреБ рд╣реИред

рд╕реАрдЦрдиреЗ рдХреА рджрд░ рдпрд╛рдирд┐ рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рджреВрд╕рд░реА рдЪрд╛рд▓ рд╣реИ: рд╣рдо рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рдХреЛ
рдзреАрд░реЗ-рдзреАрд░реЗ рдХрдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ ред рд╕рд╛рд╣рд┐рддреНрдп рдореЗрдВ, рдЖрдк рдХрднреА-рдХрднреА рдЗрд╕реЗ *рдХреНрд╖рдп* рдпрд╛ *рдПрдиреАрд▓рд┐рдВрдЧ* рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд рджреЗрдЦреЗрдВрдЧреЗред
рдХреЗрд░рд╕ рдореЗрдВ, рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рдПрдХ *рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рд╢реЗрдбреНрдпреВрд▓рд░* рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдЪреНрдЫрд╛ рд╣реИ
`PolynomialDecay` тАФ рдирд╛рдо рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рде рдпрд╣ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╡реИрд▓реНрдпреВрдЬрд╝ рд╕реЗ рдЕрдВрддрд┐рдо рд╡реИрд▓реНрдпреВрдЬрд╝ рддрдХ
рд╕реАрдЦрдиреЗ рдХреА рджрд░ рдХреЛ рд░реИрдЦрд┐рдХ рд░реВрдк рд╕реЗ рдХрдо рдХрд░ рджреЗрддрд╛ рд╣реИ, рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╣рдо рдЪрд╛рд╣рддреЗ рд╣реИрдВред рд╢реЗрдбреНрдпреВрд▓рд░ рдХрд╛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП,
 рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдореЗрдВ рдпрд╣ рдмрддрд╛рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХрд┐рддрдирд╛ рд▓рдВрдмрд╛ рд╣реЛрдЧрд╛ред рд╣рдо рдЗрд╕рдХреА рдЧрдгрдирд╛ рдиреАрдЪреЗ `num_train_steps` рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рддреЗ рд╣реИрдВред

```py
from tensorflow.keras.optimizers.schedules import PolynomialDecay

batch_size = 8
num_epochs = 3
# The number of training steps is the number of samples in the dataset, divided by the batch size then multiplied
# by the total number of epochs. Note that the tf_train_dataset here is a batched tf.data.Dataset,
# not the original Hugging Face Dataset, so its len() is already num_samples // batch_size.
num_train_steps = len(tf_train_dataset) * num_epochs
lr_scheduler = PolynomialDecay(
    initial_learning_rate=5e-5, end_learning_rate=0.0, decay_steps=num_train_steps
)
from tensorflow.keras.optimizers import Adam

opt = Adam(learning_rate=lr_scheduler)
```

<Tip>

ЁЯдЧ рдЯреНрд░рд╛рдВрд╕рдлреЙрд░реНрдорд░реНрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдПрдХ `create_optimizer()` рдлрд╝рдВрдХреНрд╢рди рднреА рд╣реИ рдЬреЛ рд▓рд░реНрдирд┐рдВрдЧ рд░реЗрдЯ рдХреНрд╖рдп рдХреЗ рд╕рд╛рде рдПрдХ `AdamW` рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рдмрдирд╛рдПрдЧрд╛ред рдпрд╣ рдПрдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╢реЙрд░реНрдЯрдХрдЯ рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдкрд╛рдареНрдпрдХреНрд░рдо рдХреЗ рднрд╡рд┐рд╖реНрдп рдХреЗ рдЕрдиреБрднрд╛рдЧреЛрдВ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рджреЗрдЦреЗрдВрдЧреЗред

</Tip>

рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдорд╛рд░рд╛ рдмрд┐рд▓реНрдХреБрд▓ рдирдпрд╛ рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рд╣реИ, рдФрд░ рд╣рдо рдЗрд╕рдХреЗ рд╕рд╛рде рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдореЙрдбрд▓ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓реЛрдб рдХрд░реЗрдВ, рддрд╛рдХрд┐ рд╣рдорд╛рд░реЗ рджреНрд╡рд╛рд░рд╛ рдЕрднреА-рдЕрднреА рдХрд┐рдП рдЧрдП рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд░рди рд╕реЗ рд╡рдЬрд╝рди рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░ рд╕рдХреЗ, рдФрд░ рдлрд┐рд░ рд╣рдо рдЗрд╕реЗ рдирдП рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рдХреЗ рд╕рд╛рде рдХрдВрдкрд╛рдЗрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```py
import tensorflow as tf

model = TFAutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)
loss = tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)
model.compile(optimizer=opt, loss=loss, metrics=["accuracy"])
```

рдЕрдм, рд╣рдо рдлрд┐рд░ рд╕реЗ рдлрд┐рдЯ рдХрд░реЗрдЧреЗ:

```py
model.fit(tf_train_dataset, validation_data=tf_validation_dataset, epochs=3)
```

<Tip>

ЁЯТб рдпрджрд┐ рдЖрдк рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рдЕрдкрдиреЗ рдореЙрдбрд▓ рдХреЛ рд╣рдм рдкрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк `model.fit()` рд╡рд┐рдзрд┐ рдореЗрдВ `PushToHubCallback` рдХреЗ рд╕рд╛рде рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рдо рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ [рдЕрдзреНрдпрд╛рдп 4](/course/chapter4/3) рдореЗрдВ рдФрд░ рдЬрд╛рдиреЗрдВрдЧреЗ

</Tip>

### рдореЙрдбрд▓ рдХреЗ рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рди

<Youtube id="nx10eh4CoOs"/>


рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдФрд░ рд▓реЙрд╕ рдХреЛ рдХрдо рд╣реЛрддреЗ рджреЗрдЦрдирд╛ рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдЕрдЧрд░ рд╣рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдореЙрдбрд▓ рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдпрд╛ рддреЛ рдХреБрдЫ рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╛ рдЙрддреНрдкрд╛рджрди рдореЗрдВ рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП? рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХреЗрд╡рд▓ `predict()` рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдПрдХ рдкреНрд░рддрд┐ рдХреНрд▓рд╛рд╕, рдореЙрдбрд▓ рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рд╣реЗрдб рд╕реЗ *logits* рд▓реМрдЯрд╛рдПрдЧрд╛ред

```py
preds = model.predict(tf_validation_dataset)["logits"]
```

рд╣рдо рдЙрдЪреНрдЪрддрдо рд▓реЙрдЧрд┐рдЯреН рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП `argmax` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрди рд▓реЙрдЧрд┐рдЯреНрд╕ рдХреЛ рдореЙрдбрд▓ рдХреЗ рдХреНрд▓рд╛рд╕ рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рди рдореЗрдВ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рд╕рдмрд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рдХреНрд▓рд╛рд╕ рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ:

```py
class_preds = np.argmax(preds, axis=1)
print(preds.shape, class_preds.shape)
```

```python out
(408, 2) (408,)
```

рдЕрдм, рдХреБрдЫ рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрди `preds` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ! рд╣рдо MRPC рдбреЗрдЯрд╛рд╕реЗрдЯ рд╕реЗ рдЬреБрдбрд╝реЗ рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХреЛ рдЙрддрдиреА рд╣реА рдЖрд╕рд╛рдиреА рд╕реЗ рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рддрдиреА рдЖрд╕рд╛рдиреА рд╕реЗ рд╣рдордиреЗ рдбреЗрдЯрд╛рд╕реЗрдЯ рд▓реЛрдб рдХрд┐рдпрд╛, рдЗрд╕ рдмрд╛рд░ `evaluate.load()` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рдеред рдЗрд╕рдиреЗ рдПрдХ рд╡рд╕реНрддреБ рд▓реМрдЯрд╛рдпрд╛ рдЬрд┐рд╕рдореЗ рдПрдХ `compute()` рд╡рд┐рдзрд┐ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдо рдореАрдЯреНрд░рд┐рдХ рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```py
import evaluate

metric = evaluate.load("glue", "mrpc")
metric.compute(predictions=class_preds, references=raw_datasets["validation"]["label"])
```

```python out
{'accuracy': 0.8578431372549019, 'f1': 0.8996539792387542}
```

рдЖрдкрдХреЛ рдорд┐рд▓рдиреЗ рд╡рд╛рд▓реЗ рд╕рдЯреАрдХ рдкрд░рд┐рдгрд╛рдо рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдореЙрдбрд▓ рд╣реЗрдб рдХреЗ рдХреНрд░рдорд░рд╣рд┐рдд рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рдмрджрд▓рд╛рд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣рд╛рдВ, рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдорд╛рд░реЗ рдореЙрдбрд▓ рдХрд╛ рд╕рддреНрдпрд╛рдкрди рд╕реЗрдЯ рдкрд░ 85.78% рдХреА рд╕рдЯреАрдХрддрд╛ рд╣реИ рдФрд░ 89.97 рдХрд╛ F1 рд╕реНрдХреЛрд░ рд╣реИред рд╡реЗ рджреЛ  рдореЗрдЯреНрд░рд┐рдХреНрд╕ рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ GLUE рдмреЗрдВрдЪрдорд╛рд░реНрдХ рдХреЗ рд▓рд┐рдП MRPC рдбреЗрдЯрд╛рд╕реЗрдЯ рдкрд░ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред [BERT рдкреЗрдкрд░](https://arxiv.org/pdf/1810.04805.pdf) рдореЗрдВ рдЯреЗрдмрд▓ рдиреЗ рдмреЗрд╕ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП F1 рд╕реНрдХреЛрд░ 88.9 рдмрддрд╛рдпрд╛ред рд╡рд╣ рдПрдХ `uncased` рдореЙрдбрд▓ рдерд╛ рдЬрдмрдХрд┐ рд╣рдо рд╡рд░реНрддрдорд╛рди рдореЗрдВ `cased` рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЬреЛ рдмреЗрд╣рддрд░ рдкрд░рд┐рдгрд╛рдо рдХреА рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХрд░рддрд╛ рд╣реИред

рдпрд╣ Keras API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╛рдЗрди-рдЯреНрдпреВрдирд┐рдВрдЧ рдХреЗ рдкрд░рд┐рдЪрдп рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рд╛рдорд╛рдиреНрдп NLP рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг [рдЕрдзреНрдпрд╛рдп 7](course/chapter7) рдореЗрдВ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрджрд┐ рдЖрдк Keras API рдкрд░ рдЕрдкрдиреЗ рдХреМрд╢рд▓ рдХреЛ рд╕реБрдзрд╛рд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ GLUE SST-2 рдбреЗрдЯрд╛рд╕реЗрдЯ рдкрд░ рдПрдХ рдореЙрдбрд▓ рдХреЛ рдлрд╛рдЗрди-рдЯреНрдпреВрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ, рдбреЗрдЯрд╛ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдпрд╛рдирд┐ рдбреЗрдЯрд╛ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬрд┐рд╕реЗ рдЖрдкрдиреЗ рд╕реЗрдХреНрд╢рди 2 рдореЗрдВ рдХрд┐рдпрд╛ рдерд╛
