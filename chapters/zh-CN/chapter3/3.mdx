<FrameworkSwitchCourse {fw} />

# ä½¿ç”¨ Trainer API å¾®è°ƒæ¨¡å‹ [[ä½¿ç”¨ Trainer API å¾®è°ƒæ¨¡å‹]]

<CourseFloatingBanner chapter={3}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/notebooks/blob/master/course/zh-CN/chapter3/section3.ipynb"},
    {label: "Aws Studio", value: "https://studiolab.sagemaker.aws/import/github/huggingface/notebooks/blob/master/course/zh-CN/chapter3/section3.ipynb"},
]} />

<Youtube id="nvBXf7s7vTI"/>

ğŸ¤— Transformers æä¾›äº†ä¸€ä¸ª `Trainer` ç±»ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨æ•°æ®é›†ä¸Šå¾®è°ƒä»»ä½•é¢„è®­ç»ƒæ¨¡å‹ã€‚åœ¨ä¸Šä¸€èŠ‚ä¸­å®Œæˆæ‰€æœ‰æ•°æ®é¢„å¤„ç†å·¥ä½œåï¼Œä½ åªéœ€å®Œæˆå‡ ä¸ªæ­¥éª¤æ¥å®šä¹‰ `Trainer` ã€‚æœ€å›°éš¾çš„éƒ¨åˆ†å¯èƒ½æ˜¯å‡†å¤‡è¿è¡Œ `Trainer.train()` æ‰€éœ€çš„ç¯å¢ƒï¼Œå› ä¸ºåœ¨ CPU ä¸Šè¿è¡Œé€Ÿåº¦éå¸¸æ…¢ã€‚å¦‚æœä½ æ²¡æœ‰è®¾ç½® GPUï¼Œå¯ä»¥ä½¿ç”¨ [Google Colab](https://colab.research.google.com/) ï¼ˆå›½å†…ç½‘ç»œæ— æ³•ä½¿ç”¨ï¼‰ ä¸Šè·å¾—å…è´¹çš„ GPU æˆ– TPUã€‚

ä¸‹é¢çš„ç¤ºä¾‹å‡è®¾ä½ å·²ç»æ‰§è¡Œäº†ä¸Šä¸€èŠ‚ä¸­çš„ç¤ºä¾‹ã€‚ä¸‹é¢æ˜¯åœ¨å¼€å§‹å­¦ä¹ è¿™ä¸€èŠ‚ä¹‹å‰ä½ éœ€è¦è¿è¡Œçš„ä»£ç ï¼š

```py
from datasets import load_dataset
from transformers import AutoTokenizer, DataCollatorWithPadding

raw_datasets = load_dataset("glue", "mrpc")
checkpoint = "bert-base-uncased"
tokenizer = AutoTokenizer.from_pretrained(checkpoint)


def tokenize_function(example):
    return tokenizer(example["sentence1"], example["sentence2"], truncation=True)


tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)
data_collator = DataCollatorWithPadding(tokenizer=tokenizer)
```

### Training [[Training]]

åœ¨æˆ‘ä»¬å®šä¹‰ `Trainer` ä¹‹å‰ç¬¬ä¸€æ­¥è¦å®šä¹‰ä¸€ä¸ª `TrainingArguments` ç±»ï¼Œå®ƒåŒ…å« `Trainer` åœ¨è®­ç»ƒå’Œè¯„ä¼°ä¸­ä½¿ç”¨çš„æ‰€æœ‰è¶…å‚æ•°ã€‚ä½ åªéœ€è¦æä¾›çš„å‚æ•°æ˜¯ä¸€ä¸ªç”¨äºä¿å­˜è®­ç»ƒåçš„æ¨¡å‹ä»¥åŠè®­ç»ƒè¿‡ç¨‹ä¸­çš„ checkpoint çš„ç›®å½•ã€‚å¯¹äºå…¶ä½™çš„å‚æ•°ä½ å¯ä»¥ä¿ç•™é»˜è®¤å€¼ï¼Œè¿™å¯¹äºç®€å•çš„å¾®è°ƒåº”è¯¥æ•ˆæœå°±å¾ˆå¥½äº†ã€‚

```py
from transformers import TrainingArguments

training_args = TrainingArguments("test-trainer")
```

<Tip>

ğŸ’¡ å¦‚æœä½ æƒ³åœ¨è®­ç»ƒæœŸé—´è‡ªåŠ¨å°†æ¨¡å‹ä¸Šä¼ åˆ° Hubï¼Œè¯·å°† `push_to_hub=True` æ·»åŠ åˆ° TrainingArguments ä¹‹ä¸­ã€‚æˆ‘ä»¬å°†åœ¨ [ç¬¬å››ç« ](/course/chapter4/3) ä¸­è¯¦ç»†ä»‹ç»è¿™éƒ¨åˆ†ã€‚

</Tip>

ç¬¬äºŒæ­¥æ˜¯å®šä¹‰æˆ‘ä»¬çš„æ¨¡å‹ã€‚ä¸ [å‰ä¸€ç« ](/course/chapter2) ä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `AutoModelForSequenceClassification` ç±»ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š

```py
from transformers import AutoModelForSequenceClassification

model = AutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)
```

ä½ ä¼šæ³¨æ„åˆ°ï¼Œå’Œ [ç¬¬äºŒç« ](/course/chapter2) ä¸åŒçš„æ˜¯ï¼Œåœ¨å®ä¾‹åŒ–æ­¤é¢„è®­ç»ƒæ¨¡å‹åä¼šæ”¶åˆ°è­¦å‘Šã€‚è¿™æ˜¯å› ä¸º BERT æ²¡æœ‰åœ¨å¥å­å¯¹åˆ†ç±»æ–¹é¢è¿›è¡Œè¿‡é¢„è®­ç»ƒï¼Œæ‰€ä»¥é¢„è®­ç»ƒæ¨¡å‹çš„ head å·²ç»è¢«ä¸¢å¼ƒï¼Œè€Œæ˜¯æ·»åŠ äº†ä¸€ä¸ªé€‚åˆå¥å­åºåˆ—åˆ†ç±»çš„æ–°å¤´éƒ¨ã€‚è¿™äº›è­¦å‘Šè¡¨æ˜ä¸€äº›æƒé‡æ²¡æœ‰ä½¿ç”¨ï¼ˆå¯¹åº”äºè¢«æ”¾å¼ƒçš„é¢„è®­ç»ƒå¤´çš„æƒé‡ï¼‰ï¼Œè€Œæœ‰äº›æƒé‡è¢«éšæœºåˆå§‹åŒ–ï¼ˆå¯¹åº”äºæ–° head çš„æƒé‡ï¼‰ã€‚

ä¸€æ—¦æœ‰äº†æˆ‘ä»¬çš„æ¨¡å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ª `Trainer` æŠŠåˆ°ç›®å‰ä¸ºæ­¢æ„å»ºçš„æ‰€æœ‰å¯¹è±¡ â€”â€” `model` ï¼Œ`training_args`ï¼Œè®­ç»ƒå’ŒéªŒè¯æ•°æ®é›†ï¼Œ `data_collator` å’Œ `tokenizer` ä¼ é€’ç»™ `Trainer` ï¼š

```py
from transformers import Trainer

trainer = Trainer(
    model,
    training_args,
    train_dataset=tokenized_datasets["train"],
    eval_dataset=tokenized_datasets["validation"],
    data_collator=data_collator,
    tokenizer=tokenizer,
)
```

è¯·æ³¨æ„ï¼Œå½“ä½ åœ¨è¿™é‡Œä¼ é€’ `tokenizer` æ—¶ï¼Œ `Trainer` é»˜è®¤ä½¿ç”¨çš„ `data_collator` æ˜¯ä¹‹å‰é¢„å®šä¹‰çš„ `DataCollatorWithPadding`ã€‚æ‰€ä»¥ä½ å¯ä»¥åœ¨æœ¬ä¾‹ä¸­å¯ä»¥è·³è¿‡ `data_collator=data_collator` ä¸€è¡Œã€‚åœ¨ç¬¬ 2 èŠ‚ä¸­å‘ä½ å±•ç¤ºè¿™éƒ¨åˆ†å¤„ç†è¿‡ç¨‹ä»ç„¶å¾ˆé‡è¦ï¼

è¦åœ¨æˆ‘ä»¬çš„æ•°æ®é›†ä¸Šå¾®è°ƒæ¨¡å‹ï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨ `Trainer` çš„ `train()` æ–¹æ³•ï¼š

```py
trainer.train()
```

å¼€å§‹å¾®è°ƒï¼ˆåœ¨ GPU ä¸Šåº”è¯¥éœ€è¦å‡ åˆ†é’Ÿï¼‰ï¼Œæ¯ 500 æ­¥æŠ¥å‘Šä¸€æ¬¡è®­ç»ƒæŸå¤±ã€‚ç„¶è€Œå®ƒä¸ä¼šå‘Šè¯‰ä½ æ¨¡å‹çš„æ€§èƒ½ï¼ˆæˆ–è´¨é‡ï¼‰å¦‚ä½•ã€‚è¿™æ˜¯å› ä¸ºï¼š

1. æˆ‘ä»¬æ²¡æœ‰å‘Šè¯‰ Trainer åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿›è¡Œè¯„ä¼°ï¼Œæ¯”å¦‚å°† `evaluation_strategy` è®¾ç½®ä¸ºâ€œ `step` â€ï¼ˆåœ¨æ¯ä¸ª `eval_steps` æ­¥éª¤è¯„ä¼°ä¸€æ¬¡ï¼‰æˆ–â€œ `epoch` â€ï¼ˆåœ¨æ¯ä¸ª epoch ç»“æŸæ—¶è¯„ä¼°ï¼‰ã€‚
2. æˆ‘ä»¬æ²¡æœ‰ä¸º `Trainer` æä¾›ä¸€ä¸ª `compute_metrics()` å‡½æ•°æ¥è®¡ç®—ä¸Šè¿°è¯„ä¼°è¿‡ç¨‹çš„æŒ‡æ ‡ï¼ˆå¦åˆ™è¯„ä¼°å°†åªä¼šè¾“å‡º lossï¼Œä½†è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸ç›´è§‚çš„æ•°å­—ï¼‰ã€‚


### è¯„ä¼° [[è¯„ä¼°]]

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ„å»ºä¸€ä¸ªæœ‰ç”¨çš„ `compute_metrics()` å‡½æ•°ï¼Œå¹¶åœ¨ä¸‹æ¬¡è®­ç»ƒæ—¶ä½¿ç”¨å®ƒã€‚è¯¥å‡½æ•°å¿…é¡»æ¥æ”¶ä¸€ä¸ª `EvalPrediction` å¯¹è±¡ï¼ˆå®ƒæ˜¯ä¸€ä¸ªå¸¦æœ‰ `predictions` å’Œ `label_ids` å­—æ®µçš„å‚æ•°å…ƒç»„ï¼‰ï¼Œå¹¶å°†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ˜ å°„åˆ°æµ®ç‚¹æ•°çš„å­—å…¸ï¼ˆå­—ç¬¦ä¸²æ˜¯è¿”å›çš„æŒ‡æ ‡åç§°ï¼Œè€Œæµ®ç‚¹æ•°æ˜¯å…¶å€¼ï¼‰ã€‚ä¸ºäº†ä»æˆ‘ä»¬çš„æ¨¡å‹ä¸­è·å¾—é¢„æµ‹ç»“æœï¼Œå¯ä»¥ä½¿ç”¨ `Trainer.predict()` å‘½ä»¤ï¼š

```py
predictions = trainer.predict(tokenized_datasets["validation"])
print(predictions.predictions.shape, predictions.label_ids.shape)
```

```python out
(408, 2) (408,)
```

`predict()` æ–¹æ³•çš„è¾“å‡ºå¦ä¸€ä¸ªå¸¦æœ‰ä¸‰ä¸ªå­—æ®µçš„å‘½åå…ƒç»„: `predictions`  `label_ids` å’Œ `metrics`  `metrics` å­—æ®µå°†åªåŒ…å«æ‰€ä¼ é€’çš„æ•°æ®é›†çš„æŸå¤±,ä»¥åŠä¸€äº›æ—¶é—´æŒ‡æ ‡(æ€»å…±èŠ±è´¹çš„æ—¶é—´å’Œå¹³å‡é¢„æµ‹æ—¶é—´)ã€‚å½“æˆ‘ä»¬å®šä¹‰äº†è‡ªå·±çš„ `compute_metrics()` å‡½æ•°å¹¶å°†å…¶ä¼ é€’ç»™ `Trainer` è¯¥å­—æ®µè¿˜å°†åŒ…å« `compute_metrics()` è¿”å›çš„ç»“æœã€‚`predict()` æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„,å½¢çŠ¶ä¸º 408 Ã— 2(408 æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®é›†ä¸­çš„å…ƒç´ æ•°é‡),è¿™æ˜¯æˆ‘ä»¬ä¼ é€’ç»™ `predict()` çš„æ•°æ®é›†ä¸­æ¯ä¸ªå…ƒç´ çš„ logits(æ­£å¦‚åœ¨ [å‰ä¸€ç« ](/course/chapter2) ä¸­çœ‹åˆ°çš„,æ‰€æœ‰ Transformer æ¨¡å‹éƒ½è¿”å› logits)ã€‚ä¸ºäº†å°†å®ƒä»¬è½¬åŒ–ä¸ºå¯ä»¥ä¸æˆ‘ä»¬çš„æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒçš„é¢„æµ‹å€¼,æˆ‘ä»¬éœ€è¦æ‰¾å‡ºç¬¬äºŒä¸ªç»´åº¦ä¸Šå–å€¼æœ€å¤§çš„ç´¢å¼•:

```py
import numpy as np

preds = np.argmax(predictions.predictions, axis=-1)
```

æˆ‘ä»¬ç°åœ¨å¯ä»¥å°†è¿™äº› `preds` ä¸æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒã€‚ä¸ºäº†æ„å»ºæˆ‘ä»¬çš„ `compute_metric()` å‡½æ•°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ ğŸ¤— [Evaluate](https://github.com/huggingface/evaluate/) åº“ä¸­çš„æŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥åƒåŠ è½½æ•°æ®é›†ä¸€æ ·è½»æ¾åœ°åŠ è½½ä¸ MRPC æ•°æ®é›†å…³è”çš„æŒ‡æ ‡ï¼Œè¿™æ¬¡æ˜¯ä½¿ç”¨ `evaluate.load()` å‡½æ•°ã€‚è¿”å›çš„å¯¹è±¡æœ‰ä¸€ä¸ª `compute()` æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥è¿›è¡ŒæŒ‡æ ‡çš„è®¡ç®—ï¼š

```py
import evaluate

metric = evaluate.load("glue", "mrpc")
metric.compute(predictions=preds, references=predictions.label_ids)
```

```python out
{'accuracy': 0.8578431372549019, 'f1': 0.8996539792387542}
```

ä½ å¾—åˆ°çš„ç¡®åˆ‡ç»“æœå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºæ¨¡å‹å¤´éƒ¨çš„éšæœºåˆå§‹åŒ–å¯èƒ½ä¼šæ”¹å˜å…¶æŒ‡æ ‡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æ¨¡å‹åœ¨éªŒè¯é›†ä¸Šçš„å‡†ç¡®ç‡ä¸º 85.78ï¼…ï¼ŒF1 åˆ†æ•°ä¸º 89.97ã€‚è¿™æ˜¯ç”¨äºè¯„ä¼° MRPC æ•°æ®é›†åœ¨ GLUE åŸºå‡†æµ‹è¯•ä¸­çš„ç»“æœçš„ä¸¤ä¸ªæŒ‡æ ‡ã€‚åœ¨ BERT è®ºæ–‡ä¸­çš„è¡¨æ ¼ä¸­ï¼ŒåŸºç¡€æ¨¡å‹çš„ F1 åˆ†æ•°ä¸º 88.9ã€‚é‚£æ˜¯ uncased æ¨¡å‹ï¼Œè€Œæˆ‘ä»¬ç°åœ¨æ­£åœ¨ä½¿ç”¨ cased æ¨¡å‹ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬å¾—åˆ°äº†æ›´å¥½çš„ç»“æœã€‚

æœ€åæŠŠæ‰€æœ‰ä¸œè¥¿æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† `compute_metrics()` å‡½æ•°ï¼š

```py
def compute_metrics(eval_preds):
    metric = evaluate.load("glue", "mrpc")
    logits, labels = eval_preds
    predictions = np.argmax(logits, axis=-1)
    return metric.compute(predictions=predictions, references=labels)
```

ä¸ºäº†æŸ¥çœ‹æ¨¡å‹åœ¨æ¯ä¸ªè®­ç»ƒå‘¨æœŸç»“æŸæ—¶çš„å¥½åï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ `compute_metrics()` å‡½æ•°å®šä¹‰ä¸€ä¸ªæ–°çš„ `Trainer` 

```py
training_args = TrainingArguments("test-trainer", evaluation_strategy="epoch")
model = AutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)

trainer = Trainer(
    model,
    training_args,
    train_dataset=tokenized_datasets["train"],
    eval_dataset=tokenized_datasets["validation"],
    data_collator=data_collator,
    tokenizer=tokenizer,
    compute_metrics=compute_metrics,
)
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªæ–°çš„ `TrainingArguments` ï¼Œå…¶ `evaluation_strategy` è®¾ç½®ä¸º `epoch` å¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªæ–°æ¨¡å‹ã€‚å¦‚æœä¸åˆ›å»ºæ–°çš„æ¨¡å‹å°±ç›´æ¥è®­ç»ƒï¼Œå°±åªä¼šç»§ç»­è®­ç»ƒæˆ‘ä»¬å·²ç»è®­ç»ƒè¿‡çš„æ¨¡å‹ã€‚ä¸ºäº†å¯åŠ¨æ–°çš„è®­ç»ƒï¼Œæˆ‘ä»¬æ‰§è¡Œï¼š

```py
trainer.train()
```

è¿™ä¸€æ¬¡ï¼Œå®ƒå°†åœ¨æ¯ä¸ª epoch ç»“æŸæ—¶åœ¨è®­ç»ƒæŸå¤±çš„åŸºç¡€ä¸ŠæŠ¥å‘ŠéªŒè¯æŸå¤±å’ŒæŒ‡æ ‡ã€‚åŒæ ·ï¼Œç”±äºæ¨¡å‹çš„éšæœºå¤´éƒ¨åˆå§‹åŒ–ï¼Œè¾¾åˆ°çš„å‡†ç¡®ç‡/F1 åˆ†æ•°å¯èƒ½ä¸æˆ‘ä»¬å‘ç°çš„ç•¥æœ‰ä¸åŒï¼Œè¿™æ˜¯ç”±äºæ¨¡å‹å¤´éƒ¨çš„éšæœºåˆå§‹åŒ–é€ æˆçš„ï¼Œä½†åº”è¯¥ç›¸å·®ä¸å¤šã€‚ `Trainer` å¯ä»¥åœ¨å¤šä¸ª GPU æˆ– TPU ä¸Šè¿è¡Œï¼Œå¹¶æä¾›è®¸å¤šé€‰é¡¹ï¼Œä¾‹å¦‚æ··åˆç²¾åº¦è®­ç»ƒï¼ˆåœ¨è®­ç»ƒçš„å‚æ•°ä¸­ä½¿ç”¨ `fp16 = True` ï¼‰ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬åç« è®¨è®ºå®ƒæ”¯æŒçš„æ‰€æœ‰å†…å®¹ã€‚

ä½¿ç”¨ `Trainer` API å¾®è°ƒçš„ä»‹ç»åˆ°æ­¤ç»“æŸã€‚åœ¨ [ç¬¬ä¸ƒç« ](/course/chapter7) ä¸­ä¼šç»™å‡ºä¸€ä¸ªå¯¹å¤§å¤šæ•°å¸¸è§çš„ NLP ä»»åŠ¡è¿›è¡Œè®­ç»ƒçš„ä¾‹å­ï¼Œä½†ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ PyTorch ä¸­åšç›¸åŒçš„æ“ä½œã€‚

<Tip>

âœï¸ **è¯•è¯•çœ‹ï¼** ä½¿ç”¨ä½ åœ¨ç¬¬ 2 èŠ‚ä¸­å­¦åˆ°çš„æ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œåœ¨ GLUE SST-2 æ•°æ®é›†ä¸Šå¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚

</Tip>

